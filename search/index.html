<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">
    <title>JS Bin</title>
</head>

<body>
    <style type="text/css">
    .sec {
        background: #fff;
        padding: 10px;
        margin: 10px;
        color: #333;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
        box-shadow: 0 0 2px rgba(0, 0, 0, 0.3);
        line-height: 1.4;
    }
    
    .ques {
        font-size: 18px;
        margin-bottom: 10px;
    }
    
    .answer {
        font-size: 14px;
        color: #777;
    }
    
    .hghlght {
        background-color: yellow;
    }
    
    .search-wrpr {
        text-align: center;
    }
    
    .search {
        padding: 5px 8px;
        width: 300px;
    }
    
    .sec-wrpr {
        display: none;
    }
    
    .search-form {
        margin-bottom: 10px;
        overflow: auto;
        text-align: center;
        border-bottom: 1px solid #dfe1e8;
    }
    
    .search-form input {
        width: 50px;
    }
    
    .search-form label {
        display: inline-block;
    }
    
    .search-form div {
        padding: 10px 10px;
        display: inline-block;
    }
    
    .search-form div:first-child {
        border: 0;
    }
    </style>
    <div class="search-form">
        <div>
            <label>Full Match</label>
            <input type="number" class="full" />
        </div>
        <div>
            <label>Partial Match</label>
            <input type="number" class="partial" />
        </div>
        <div>
            <label>Unique Match</label>
            <input type="number" class="unique" />
        </div>
        <div>
            <label>Repeat Word</label>
            <input type="number" class="repeat" />
        </div>
        <div>
            <label>In Sequence</label>
            <input type="number" class="sequence" />
        </div>
        <div>
            <label>Case Sensitive Match</label>
            <input type="number" class="case_sensitive" />
        </div>
        <div>
            <label>Minimum Relevance Score</label>
            <input type="number" class="min_rel" />
        </div>
    </div>
    <div class="search-wrpr">
        <input type="text" class="search" />
    </div>
    <div class="sec-wrpr-res"></div>
    <div class="sec-wrpr">
    </div>
    <script src="jquery-3.1.1.min.js"></script>
    <script>
    $(document).on("input", ".search-form input", function() {
        weightage = {
            "fullMatch": $(".full").val(),
            "partialMatch": $(".partial").val(),
            "uniqueMatch": $(".unique").val(),
            "repeatMatch": $(".repeat").val(),
            "sequence": $(".sequence").val(),
            "caseMatch": $(".case_sensitive").val(),
            "minRelevance": $(".min_rel").val()
        };
        localStorage.weightage = JSON.stringify(weightage);
    });

    var updateFormLabels = function(weightage) {
        $(".full").val(weightage.fullMatch);
        $(".partial").val(weightage.partialMatch);
        $(".unique").val(weightage.uniqueMatch);
        $(".repeat").val(weightage.repeatMatch);
        $(".sequence").val(weightage.sequence);
        $(".case_sensitive").val(weightage.caseMatch);
        $(".min_rel").val(weightage.minRelevance);
    };


    var defaultWeightage = {
            fullMatch: 2,
            partialMatch: 1,
            uniqueMatch: 3,
            repeatMatch: 2,
            sequence: 1.5,
            caseMatch: 2,
            minRelevance: .6
        },
        weightage = localStorage.weightage ? JSON.parse(localStorage.weightage) : defaultWeightage;
    updateFormLabels(weightage);

    var data = [];
    $.ajax({
        url: 'data.json',
        dataType: 'json',
        async: false
    }).done(function(response) {
        console.log(response);
        data = response;
    });

    var dataArray = [];
    for (var i = 0; i < data.length; i++) {
        var dataItem = data[i];
        for (var key in dataItem) {
            dataArray.push($.trim(key));
            dataArray.push($.trim(dataItem[key]));
        }
    }
    var q = "";
    console.log("Data Size: " + dataArray.length);
    for (var i = 0; i < dataArray.length; i++) {
        q += '<div class="sec" data-id="' + (i + 1) + '">\
                    <div class="ques">' + dataArray[i] + '</div>\
                </div>';
    }
    $(".sec-wrpr").html(q);
    </script>
    <script type="text/javascript">
    var timeout;
    $(document).on("input", ".search", function() {
        $this = $(this);
        clearTimeout(timeout);
        timeout = setTimeout(function() {
            var term = $this.val();
            search(term);
        }, 200);

    });
    var questions = [],
        questionMeta = [];

    var search = function(searchTerm) {
        searchInProgress = true;

        var searchStartTime = Date.now();
        questions = [];
        $(".sec-wrpr-res").html($(".sec-wrpr").html());
        $(".sec-wrpr-res .sec").each(function() {
            var question = {
                text: $(this).text().replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, " ").replace(/[\s\t\r\n]+/g, " ").split(" ").reduce(function(a, v) {
                    if (v.length > 2 || (v === v.toUpperCase() && v.length > 1)) {
                        a.push(v);
                    }
                    return a;
                }, []),
                matchScore: 0,
                matchedWordIndex: [],
                lastMatch: {},
                maxScore: 0
            };
            question.id = $(this).data("id");
            questions.push(question);
        });

        var questionProcessTime = Date.now();

        console.log("Time taken by questions: " + ((questionProcessTime - searchStartTime) / 1000));

        var searchItems = searchTerm.replace(/[.,\/#!$%\^&\*;:{}=\-_`~()]/g, " ").replace(/[\s\t\r\n]+/g, " ").split(" ").reduce(function(a, v) {
            if (v.length > 2 || (v === v.toUpperCase() && v.length > 1)) {
                a.push(v);
            }
            return a;
        }, []);
        processSearch(searchItems);
        searchInProgress = false;
    }

    var highlightText = function(searchItems) {
        for (var i = 0; i < searchItems.length; i++) {
            $(".sec-wrpr-res .sec").children().each(function() {
                var text = " " + $(this).html();
                text = text.replace(new RegExp(" " + searchItems[i], "ig"), function(match) {

                    return ' <span class="hghlght">' + match.trim() + '</span>';
                });
                $(this).html(text.trim());
            });
        }
    }

    var sortQuestions = function() {
        var $sections = $(".sec-wrpr-res .sec");

        $sections = $sections.filter(function(index, obj) {
            var quesID = $(obj).data('id');
            var score = questionMeta[quesID].relScore;
            return score >= weightage.minRelevance;
        }).sort(function(a, b) {
            return questionMeta[$(b).data('id')].relScore - questionMeta[$(a).data('id')].relScore;
        });
        $(".sec-wrpr-res").html($sections);

    }

    var processSearch = function(searchItems) {
        var processStartTime = Date.now();
        for (var i = 0; i < questions.length; i++) {

            searchQuestion(questions[i], searchItems);

        }
        var processEndTime = Date.now();
        console.log("Search Time: " + ((processEndTime - processStartTime) / 1000));

        sortQuestions();

        var sortEndTime = Date.now();
        console.log("Sort Time: " + ((sortEndTime - processEndTime) / 1000));

        highlightText(searchItems);
        var highlightTime = Date.now();
        console.log("Highlight Time: " + ((highlightTime - sortEndTime) / 1000));
    }

    var searchQuestion = function(question, searchItems) {
        for (var j = 0; j < searchItems.length; j++) {
            var searchLCase = searchItems[j].toLowerCase();
            for (var k = 0; k < question.text.length; k++) {

                var questionLCase = question.text[k].toLowerCase();


                if (questionLCase.indexOf(searchLCase) === 0) {
                    var matchScore = 0;

                    if (question.matchedWordIndex.indexOf(j) > -1) {
                        //Repeat Word
                        matchScore += weightage.repeatMatch;
                    } else {
                        //Unique Word
                        matchScore += weightage.uniqueMatch;
                        question.matchedWordIndex.push(j);
                    }

                    if (questionLCase === searchLCase) {
                        //Full Search
                        matchScore *= weightage.fullMatch;
                    } else {
                        //Partial Search
                        matchScore *= weightage.partialMatch;
                    }

                    if (question.text[k] === searchItems[j]) {
                        //Case Sensitive
                        matchScore *= weightage.caseMatch;
                    } else {
                        //Case Insensitive
                        //Do Nothing as of now
                    }

                    if ((question.lastMatch.searchIndex === j - 1) && (question.lastMatch.questionIndex === k - 1)) {
                        // If it is a sequence
                        matchScore *= weightage.sequence;
                    }
                    question.lastMatch = {
                        searchIndex: j,
                        questionIndex: k
                    }
                    question.matchScore += matchScore;

                }

            }
            question.maxScore += weightage.fullMatch * weightage.uniqueMatch;
        }

        questionMeta[question.id] = {
            "score": question.matchScore,
            "relScore": question.matchScore / question.maxScore
        }
    }
    </script>
</body>

</html>
